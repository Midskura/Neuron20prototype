# Template Auto-Population Implementation Summary

## üéØ What We Built: Option C (Hybrid Approach)

BD creates detailed inquiries ‚Üí PD receives auto-populated pricing templates ‚Üí PD fills in prices (hybrid: can add/remove charges)

---

## ‚úÖ **Phase 1: BD Inquiry Enhancement** - COMPLETE

### Type System Updates

**File**: `/types/pricing.ts`

#### New Types Added:

```typescript
// Service in Inquiry - includes detailed specifications
export interface InquiryService {
  service_type: ServiceType;
  service_details: BrokerageDetails | ForwardingDetails | TruckingDetails | MarineInsuranceDetails | OthersDetails | Record<string, any>;
}
```

####  Updated Inquiry Interface:

**Before**:
```typescript
export interface Inquiry {
  services: ServiceType[]; // Just ["Brokerage", "Forwarding"]
}
```

**After**:
```typescript
export interface Inquiry {
  services: InquiryService[]; // Detailed service specs
}
```

### What This Means:

BD can now capture:
- Service type (Brokerage, Forwarding, etc.)
- **PLUS** all service-specific details (subtype, shipment type, mode, routes, etc.)

**Example**:
```typescript
{
  services: [
    {
      service_type: "Brokerage",
      service_details: {
        subtype: "Import Ocean",
        shipment_type: "FCL",
        pod: "Port of Manila",
        mode: "Ocean",
        cargo_type: "General",
        commodity: "Pharmaceuticals",
        declared_value: 500000
      }
    },
    {
      service_type: "Forwarding",
      service_details: {
        incoterms: "CIF",
        mode: "Ocean",
        pol: "Shanghai",
        pod: "Manila",
        cargo_type: "General",
        commodity: "Medical Supplies"
      }
    }
  ]
}
```

---

## ‚úÖ **Phase 2: Service Templates Configuration** - COMPLETE

### Template System

**File**: `/config/serviceTemplates.ts`

####  ChargeTemplate Interface:

```typescript
export interface ChargeTemplate {
  category: ChargeCategory;           // Which category it belongs to
  charge_type: string;                 // Specific charge name
  description?: string;                // Helper text
  default_quantity: number;            // Pre-filled quantity
  default_unit: string;                // Pre-filled unit
  is_required: boolean;                // Can PD remove this?
  notes?: string;                      // Instructions for PD
}
```

#### Template Coverage:

**Brokerage Templates**: 
- 4 subtypes √ó 4 shipment types = 16 combinations
- Example: `BROKERAGE_TEMPLATES["Import Ocean"]["FCL"]` = 15 charges

**Forwarding Templates**:
- 3 modes (Air, Ocean, Land)
- Example: `FORWARDING_TEMPLATES["Ocean"]` = 14 charges

**Trucking Template**:
- 5 standard charges (same for all truck types)

**Marine Insurance Template**:
- 1 charge (Insurance Premium)

**Others**:
- No template (fully custom)

### Example Template:

```typescript
BROKERAGE_TEMPLATES["Import Ocean"]["FCL"] = [
  {
    category: "Brokerage Charges",
    charge_type: "Entry",
    default_quantity: 1,
    default_unit: "per entry",
    is_required: true
  },
  {
    category: "Brokerage Charges",
    charge_type: "Clearance",
    default_quantity: 1,
    default_unit: "per container",
    is_required: true
  },
  {
    category: "Brokerage Charges",
    charge_type: "Permit",
    default_quantity: 1,
    default_unit: "per shipment",
    is_required: false,
    notes: "e.g., FDA, NFA, BFAD"
  },
  // ... 12 more charges
];
```

### Helper Functions:

```typescript
// Get templates for a service
getServiceChargeTemplates(serviceType, serviceDetails): ChargeTemplate[]

// Check if service has enough details for templates
canGenerateTemplates(serviceType, serviceDetails): boolean
```

---

## ‚úÖ **Phase 3: Auto-Population in QuotationBuilderV2** - COMPLETE

### Updated Logic

**File**: `/components/pricing/quotations/QuotationBuilderV2.tsx`

#### Import Added:

```typescript
import { getServiceChargeTemplates, canGenerateTemplates } from "../../../config/serviceTemplates";
```

#### Auto-Population on Inquiry Load:

**Before**:
```typescript
// Empty line items
const initialServices = foundInquiry.services.map(serviceType => ({
  service_type: serviceType,
  line_items: [],  // ‚Üê PD has to add everything manually
  subtotal: 0
}));
```

**After**:
```typescript
// AUTO-POPULATED line items
const initialServices = inquiryServices.map((inquiryService) => {
  const serviceType = typeof inquiryService === 'string' 
    ? inquiryService 
    : inquiryService.service_type;
    
  const serviceDetails = typeof inquiryService === 'string' 
    ? {} 
    : inquiryService.service_details || {};
  
  // üî• GET TEMPLATES
  const chargeTemplates = getServiceChargeTemplates(serviceType, serviceDetails);
  
  // üî• CONVERT TO LINE ITEMS WITH EMPTY PRICES
  const autoGeneratedLineItems = chargeTemplates.map((template, idx) => ({
    id: `line-${Date.now()}-${idx}`,
    quotation_service_id: "",
    category: template.category,
    charge_type: template.charge_type,
    description: template.notes || "",
    quantity: template.default_quantity,  // ‚úÖ Pre-filled
    unit: template.default_unit,          // ‚úÖ Pre-filled
    selling_price: 0,                     // ‚Üê PD FILLS THIS
    buying_price: undefined,              // ‚Üê PD FILLS THIS (optional)
    vendor_id: undefined,                 // ‚Üê PD FILLS THIS (optional)
    line_total: 0
  }));
  
  return {
    service_type: serviceType,
    service_details: serviceDetails,      // ‚úÖ Pre-filled from inquiry
    line_items: autoGeneratedLineItems,   // ‚úÖ Auto-populated!
    subtotal: 0
  };
});
```

---

## üé® User Experience: Before vs After

### **BEFORE** (Manual Entry):

```
BD creates inquiry:
- Customer: Unilab
- Services: ["Brokerage", "Forwarding"]  ‚Üê Basic

PD converts to quotation:
1. Selects Brokerage service
2. Fills ALL details manually:
   - Subtype: Import Ocean
   - Shipment type: FCL
   - POD, mode, cargo type, etc.
3. Clicks "+ Add Charge" 15 times
4. For each charge, manually:
   - Select category
   - Select charge type
   - Enter quantity
   - Select unit
   - Enter selling price
   - (Optional) Select vendor, enter buying price

Time: ~30 minutes of data entry
```

### **AFTER** (Template Auto-Population):

```
BD creates detailed inquiry:
- Customer: Unilab
- Service 1: Brokerage
  - Subtype: Import Ocean
  - Shipment type: FCL
  - POD: Port of Manila
  - Mode: Ocean
  - Cargo type: General
  - Commodity: Pharmaceuticals
  - (all details captured)
- Service 2: Forwarding
  - Incoterms: CIF
  - Mode: Ocean
  - POL: Shanghai
  - POD: Manila
  - (all details captured)

PD converts to quotation:
1. QuotationBuilderV2 opens with:
   ‚úÖ Customer pre-loaded
   ‚úÖ Services pre-selected
   ‚úÖ Service details pre-filled (read-only or editable)
   ‚úÖ Line items AUTO-GENERATED (15 for Brokerage, 14 for Forwarding)
   
2. PD sees pricing table with:
   Category | Charge Type | Qty | Unit | Selling ‚Ç± | Vendor | Buying ‚Ç± | Total
   ---------|-------------|-----|------|-----------|--------|----------|------
   Brokerage Charges | Entry | 1 | per entry | [____] | [____] | [____] | ‚Ç±0
   Brokerage Charges | Clearance | 1 | per container | [____] | [____] | [____] | ‚Ç±0
   Brokerage Charges | Permit | 1 | per shipment | [____] | [____] | [____] | ‚Ç±0
   ... (12 more rows)
   
3. PD just fills in the blanks:
   - Selling prices (required)
   - Vendors (optional)
   - Buying prices (if vendor assigned)
   
4. Can add extra charges if needed (Hybrid!)
5. Can remove non-required charges if not applicable

Time: ~5-10 minutes (just pricing!)
```

---

## üîÑ Option C: Hybrid Approach Details

### What PD Can Do:

‚úÖ **See auto-populated charges** (based on service details from BD)  
‚úÖ **Fill in prices** (main job)  
‚úÖ **Add extra charges** (if inquiry missed something)  
‚úÖ **Remove optional charges** (if not applicable)  
‚úÖ **Edit quantities/units** (if defaults don't match)  
‚úÖ **Assign vendors** (as needed)

### What's Pre-Filled:

- ‚úÖ Charge category
- ‚úÖ Charge type
- ‚úÖ Default quantity
- ‚úÖ Default unit
- ‚úÖ Service details (from inquiry)

### What PD Must Fill:

- ‚ö†Ô∏è Selling prices (all charges)
- üîπ Buying prices (if vendor assigned)
- üîπ Vendors (optional)

### Intelligence Built-In:

```typescript
// If BD provides complete details ‚Üí Full template
inquiry.services = [{
  service_type: "Brokerage",
  service_details: {
    subtype: "Import Ocean",  // ‚Üê This enables template
    shipment_type: "FCL"       // ‚Üê This enables template
  }
}]
‚Üí Result: 15 charges auto-generated

// If BD provides incomplete details ‚Üí Empty or partial template
inquiry.services = [{
  service_type: "Brokerage",
  service_details: {} // Missing subtype/shipment_type
}]
‚Üí Result: Empty (PD adds manually)
```

---

## üìä Template Coverage Matrix

| Service Type | Required Details | Template Size | Notes |
|--------------|------------------|---------------|-------|
| **Brokerage** | `subtype` + `shipment_type` | 5-15 charges | Varies by combo |
| **Forwarding** | `mode` | 8-14 charges | Varies by mode |
| **Trucking** | (always works) | 5 charges | Standard set |
| **Marine Insurance** | (always works) | 1 charge | Insurance premium |
| **Others** | N/A | 0 charges | Fully custom |

### Brokerage Template Breakdown:

| Subtype | Shipment Type | Charges Generated |
|---------|---------------|-------------------|
| Import Air | FCL | 10 charges |
| Import Air | LCL | 7 charges |
| Import Ocean | FCL | **15 charges** (most detailed) |
| Import Ocean | LCL | 9 charges |
| Export Air | FCL | 7 charges |
| Export Ocean | FCL | 8 charges |
| ... | ... | ... |

### Forwarding Template Breakdown:

| Mode | Charges Generated |
|------|-------------------|
| Air | 8 charges |
| **Ocean** | **14 charges** (most detailed) |
| Land | 5 charges |

---

## üîß Technical Implementation Details

### Type Safety:

```typescript
// Backward compatible with old data
const serviceType: ServiceType = typeof inquiryService === 'string' 
  ? inquiryService              // Old: "Brokerage"
  : inquiryService.service_type; // New: { service_type: "Brokerage", service_details: {...} }

const serviceDetails = typeof inquiryService === 'string' 
  ? {}                          // Old: No details
  : inquiryService.service_details || {}; // New: { subtype: ..., shipment_type: ... }
```

### Template Matching Logic:

```typescript
export function getServiceChargeTemplates(
  serviceType: ServiceType,
  serviceDetails: any
): ChargeTemplate[] {
  switch (serviceType) {
    case "Brokerage":
      if (serviceDetails.subtype && serviceDetails.shipment_type) {
        return BROKERAGE_TEMPLATES[serviceDetails.subtype]?.[serviceDetails.shipment_type] || [];
      }
      return []; // No template if incomplete
      
    case "Forwarding":
      if (serviceDetails.mode) {
        return FORWARDING_TEMPLATES[serviceDetails.mode] || [];
      }
      return [];
      
    case "Trucking":
      return TRUCKING_TEMPLATE; // Always available
      
    case "Marine Insurance":
      return MARINE_INSURANCE_TEMPLATE; // Always available
      
    case "Others":
      return []; // No template
      
    default:
      return [];
  }
}
```

---

## üöÄ Next Steps

### üîú **Phase 4: Update BD Inquiry Form** (Not Yet Implemented)

**What Needs to Be Done**:

1. **Update BD Inquiry Creation Form**:
   - Add service detail forms (same as QuotationBuilderV2)
   - When BD selects "Brokerage", show Brokerage detail fields
   - When BD selects "Forwarding", show Forwarding detail fields
   - Etc.

2. **Files to Update**:
   - `/components/bd/InquiryForm.tsx` (or wherever BD creates inquiries)
   - Import the service form components:
     - `BrokerageFormV2`
     - `ForwardingFormV2`
     - `TruckingFormV2`
     - `MarineInsuranceFormV2`
     - `OthersFormV2`

3. **Data Flow**:
   ```
   BD fills inquiry form:
   - Customer: Unilab
   - Service: [Select] Brokerage
     ‚Üí Shows BrokerageFormV2
     ‚Üí BD fills: Subtype, Shipment Type, POD, Mode, etc.
   - Service: [Select] Forwarding
     ‚Üí Shows ForwardingFormV2
     ‚Üí BD fills: Incoterms, Mode, POL, POD, etc.
   
   Saves inquiry:
   {
     services: [
       {
         service_type: "Brokerage",
         service_details: { ... all fields filled by BD ... }
       },
       {
         service_type: "Forwarding",
         service_details: { ... all fields filled by BD ... }
       }
     ]
   }
   
   PD opens quotation builder:
   ‚Üí Line items auto-generate based on BD's service details!
   ```

### üîú **Phase 5: Update Mock Data** (For Testing)

**File**: `/data/pricingMockData.ts`

Update `mockInquiries` to use new format:

**Before**:
```typescript
export const mockInquiries: Inquiry[] = [
  {
    id: "inq-1",
    services: ["Brokerage", "Forwarding"],  // Old format
    // ...
  }
];
```

**After**:
```typescript
export const mockInquiries: Inquiry[] = [
  {
    id: "inq-1",
    services: [
      {
        service_type: "Brokerage",
        service_details: {
          subtype: "Import Ocean",
          shipment_type: "FCL",
          pod: "Port of Manila",
          mode: "Ocean",
          cargo_type: "General",
          commodity: "Pharmaceuticals",
          declared_value: 500000
        }
      },
      {
        service_type: "Forwarding",
        service_details: {
          incoterms: "CIF",
          mode: "Ocean",
          pol: "Shanghai",
          pod: "Manila",
          cargo_type: "General",
          commodity: "Medical Supplies"
        }
      }
    ],
    // ...
  }
];
```

### üîú **Phase 6: Supabase Integration**

**Tables**:
```sql
-- Inquiry services (junction table with details)
CREATE TABLE inquiry_services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  inquiry_id UUID REFERENCES bd_inquiries(id),
  service_type TEXT NOT NULL,
  service_details JSONB, -- Flexible storage for all service types
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## üìà Benefits Summary

### Time Savings:
- **Before**: 30 min data entry per quotation
- **After**: 5-10 min pricing only
- **Savings**: ~70-80% reduction in time

### Error Reduction:
- ‚úÖ No forgotten charges (all pre-populated)
- ‚úÖ Consistent charge naming
- ‚úÖ Correct units and quantities
- ‚úÖ Proper categorization

### Improved Workflow:
- BD captures full requirements upfront
- PD focuses on pricing (their expertise)
- Smoother relay race handoff
- Better data quality

### Flexibility (Option C):
- Can still add custom charges
- Can remove optional charges
- Can adjust quantities/units
- Best of both structured + flexible

---

## üêõ Known Limitations / Future Enhancements

### Current Limitations:

1. **BD Inquiry Form Not Updated Yet**
   - BD still can't capture detailed service info
   - Mock data needs manual update to test
   - Phase 4 implementation needed

2. **Template Maintenance**
   - Templates are hardcoded in `/config/serviceTemplates.ts`
   - Changes require code update
   - Future: Admin UI to manage templates

3. **No Dynamic Templates**
   - Templates are static (not customer-specific)
   - Future: Customer-specific pricing templates
   - Future: Historical pricing suggestions

### Future Enhancements:

- [ ] **Smart Pricing Suggestions**: AI-based pricing based on history
- [ ] **Customer-Specific Templates**: Different charges per customer type
- [ ] **Dynamic Template Builder**: Admin UI to create/edit templates
- [ ] **Template Versioning**: Track changes to templates over time
- [ ] **Bulk Import**: Import charges from Excel/CSV
- [ ] **Required vs Optional Flags UI**: Visual indicators for mandatory charges
- [ ] **Template Analytics**: Which charges are most commonly removed/added

---

## üìù Testing Checklist

### Unit Tests:
- [ ] `getServiceChargeTemplates()` returns correct templates
- [ ] `canGenerateTemplates()` validates service details
- [ ] Template matching for all service combinations
- [ ] Backward compatibility with old inquiry format

### Integration Tests:
- [ ] Inquiry with full details ‚Üí Auto-populates line items
- [ ] Inquiry with partial details ‚Üí Empty or partial template
- [ ] Old inquiry format (string[]) ‚Üí Still works (no crash)
- [ ] PD can add/remove charges (hybrid mode)
- [ ] Line item calculations update correctly

### UI Tests:
- [ ] Service details display correctly when from inquiry
- [ ] Line items appear in pricing breakdown
- [ ] Empty prices show as editable fields
- [ ] Can add new charges beyond template
- [ ] Can remove optional charges
- [ ] Save draft with auto-populated items
- [ ] Generate quotation with auto-populated items

---

**Status**: ‚úÖ **Phases 1-3 COMPLETE**  
**Next**: Phase 4 (Update BD Inquiry Form)  
**Date**: December 13, 2025  
**Approach**: Option C (Hybrid) - Auto-populate + PD can modify
