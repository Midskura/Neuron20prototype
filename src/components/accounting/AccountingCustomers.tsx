import { useState, useEffect, useRef } from "react";
import { Search, Plus, Building2, TrendingUp, Briefcase, Target, ArrowUp, ArrowDown, MoreHorizontal, Trash2, Users as UsersIcon } from "lucide-react";
import type { Customer, Industry, CustomerStatus } from "../../types/bd";
import { CustomDropdown } from "../bd/CustomDropdown";
import { AddCustomerPanel } from "../bd/AddCustomerPanel";
import { CustomerLedgerDetail } from "./CustomerLedgerDetail";
import { projectId, publicAnonKey } from "../../utils/supabase/info";
import { toast } from "../ui/toast-utils";

const API_URL = `https://${projectId}.supabase.co/functions/v1/make-server-c142e950`;

export function AccountingCustomers() {
  const [view, setView] = useState<"list" | "detail">("list");
  const [searchQuery, setSearchQuery] = useState("");
  const [industryFilter, setIndustryFilter] = useState<Industry | "All">("All");
  const [statusFilter, setStatusFilter] = useState<CustomerStatus | "All">("All");
  const [ownerFilter, setOwnerFilter] = useState<string>("All");
  const [isAddCustomerOpen, setIsAddCustomerOpen] = useState(false);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [allContacts, setAllContacts] = useState<any[]>([]);
  const [users, setUsers] = useState<any[]>([]);
  const [activities, setActivities] = useState<any[]>([]);
  const [openDropdownId, setOpenDropdownId] = useState<string | null>(null);
  const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Fetch users from backend
  const fetchUsers = async () => {
    try {
      const response = await fetch(`${API_URL}/users?department=Business%20Development`, {
        headers: { Authorization: `Bearer ${publicAnonKey}` },
      });
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          setUsers(result.data);
        } else {
          console.warn("Failed to fetch users:", result.error);
          setUsers([]);
        }
      } else {
        console.warn(`Error fetching users: ${response.status} ${response.statusText}`);
        setUsers([]);
      }
    } catch (error) {
      console.error("Error fetching users:", error);
      setUsers([]);
    }
  };

  // Fetch activities from backend
  const fetchActivities = async () => {
    try {
      const response = await fetch(`${API_URL}/activities`, {
        headers: { Authorization: `Bearer ${publicAnonKey}` },
        cache: 'no-store',
      });
      
      if (!response.ok) {
        setActivities([]);
        return;
      }
      
      const result = await response.json();
      if (result.success) {
        setActivities(result.data);
      } else {
        setActivities([]);
      }
    } catch (error) {
      console.error("Error fetching activities:", error);
      setActivities([]);
    }
  };

  // Fetch customers from backend
  const fetchCustomers = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      if (searchQuery) {
        params.append("search", searchQuery);
      }
      if (industryFilter && industryFilter !== "All") {
        params.append("industry", industryFilter);
      }
      if (statusFilter && statusFilter !== "All") {
        params.append("status", statusFilter);
      }
      // Use 'Accounting' role or just fetch all
      params.append("role", "Accounting");
      
      const url = `${API_URL}/customers?${params.toString()}`;
      
      const response = await fetch(url, {
        headers: {
          Authorization: `Bearer ${publicAnonKey}`,
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const result = await response.json();
      
      if (result.success) {
        setCustomers(result.data);
      }
    } catch (error) {
      console.error("Error fetching customers:", error);
    } finally {
      setIsLoading(false);
    }
  };

  // Fetch all contacts for counting
  const fetchContacts = async () => {
    try {
      const response = await fetch(`${API_URL}/contacts`, {
        headers: {
          Authorization: `Bearer ${publicAnonKey}`,
        },
      });

      const result = await response.json();
      if (result.success) {
        setAllContacts(result.data);
      }
    } catch (error) {
      console.error('Error fetching contacts:', error);
    }
  };

  // Fetch on mount
  useEffect(() => {
    fetchCustomers();
    fetchContacts();
    fetchUsers();
    fetchActivities();
  }, []);

  // Debounced search and filter updates
  useEffect(() => {
    const timer = setTimeout(() => {
      fetchCustomers();
    }, 300);
    return () => clearTimeout(timer);
  }, [searchQuery, industryFilter, statusFilter]);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setOpenDropdownId(null);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Handle delete customer
  const handleDeleteCustomer = async (customerId: string, customerName: string) => {
    if (!confirm(`Are you sure you want to delete "${customerName}"? This action cannot be undone.`)) {
      return;
    }

    try {
      const response = await fetch(`${API_URL}/customers/${customerId}`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${publicAnonKey}`,
        },
      });

      const result = await response.json();
      if (result.success) {
        await fetchCustomers(); // Refresh list
        await fetchContacts(); // Refresh contacts
        setOpenDropdownId(null); // Close dropdown
        toast.success("Customer deleted successfully");
      } else {
        toast.error(`Failed to delete customer: ${result.error}`);
      }
    } catch (error) {
      console.error("Error deleting customer:", error);
      toast.error("Failed to delete customer. Please try again.");
    }
  };

  // Handle save customer
  const handleSaveCustomer = async (customerData: Partial<Customer>) => {
    try {
      const response = await fetch(`${API_URL}/customers`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${publicAnonKey}`,
        },
        body: JSON.stringify(customerData),
      });

      const result = await response.json();
      if (result.success) {
        await fetchCustomers(); // Refresh list
        await fetchContacts(); // Refresh contacts for accurate counts
        setIsAddCustomerOpen(false);
        toast.success("Customer added successfully");
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      console.error("Error creating customer:", error);
      toast.error("Failed to create customer");
    }
  };

  // Get contact count for each customer
  const getContactCount = (customerId: string): number => {
    return allContacts.filter(c => c.customer_id === customerId).length;
  };

  // Get latest activity date for each customer
  const getLastActivityDate = (customerId: string): string | null => {
    const customerActivities = activities
      .filter(act => act.customer_id === customerId)
      .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
    
    return customerActivities.length > 0 ? customerActivities[0].date : null;
  };

  // Filter customers for owner
  const filteredCustomers = customers.filter(customer => {
    const matchesOwner = ownerFilter === "All" || customer.owner_id === ownerFilter;
    return matchesOwner;
  });

  const getOwnerName = (ownerId: string) => {
    const owner = users.find(u => u.id === ownerId);
    return owner?.name || "—";
  };

  const getStatusColor = (status: CustomerStatus) => {
    switch (status) {
      case "Active": return "#0F766E";
      case "Prospect": return "#C88A2B";
      case "Inactive": return "#6B7A76";
      default: return "#6B7A76";
    }
  };

  const formatDate = (dateString: string | null) => {
    if (!dateString) return "—";
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      day: 'numeric',
      month: 'short', 
      year: 'numeric'
    });
  };

  // Generate company logo (initials from company name)
  const getCompanyInitials = (companyName: string) => {
    if (!companyName) return '??';
    const words = companyName.split(' ');
    if (words.length >= 2) {
      return `${words[0].charAt(0)}${words[1].charAt(0)}`.toUpperCase();
    }
    return companyName.substring(0, 2).toUpperCase();
  };

  const getCompanyLogoColor = (companyName: string) => {
    if (!companyName) return '#0F766E';
    const colors = [
      '#0F766E', '#2B8A6E', '#237F66', '#1E6D59',
      '#C88A2B', '#6B7A76', '#C94F3D'
    ];
    const index = companyName.charCodeAt(0) % colors.length;
    return colors[index];
  };

  // KPI Calculations
  const currentMonth = new Date().getMonth();
  const currentYear = new Date().getFullYear();
  
  const activeCustomers = customers.filter(c => c.status === "Active").length;
  
  // New Customers Added this month
  const newCustomersAdded = customers.filter(customer => {
    const createdDate = new Date(customer.created_at);
    return createdDate.getMonth() === currentMonth && createdDate.getFullYear() === currentYear;
  }).length;
  const newCustomersQuota = 10;
  const newCustomersProgress = (newCustomersAdded / newCustomersQuota) * 100;
  const newCustomersTrend = 20;
  
  // Prospects Converted this month
  const prospectsConverted = 4;
  const prospectsQuota = 8;
  const prospectsProgress = (prospectsConverted / prospectsQuota) * 100;
  const prospectsTrend = 12;
  
  // Active Customers
  const activeCustomersCount = activeCustomers;
  const activeCustomersQuota = 50;
  const activeCustomersProgress = (activeCustomersCount / activeCustomersQuota) * 100;
  const activeCustomersTrend = 8;
  
  // Total Revenue (mock data)
  const totalRevenue = 2450000;
  const revenueQuota = 3000000;
  const revenueProgress = (totalRevenue / revenueQuota) * 100;
  const revenueTrend = -5;
  
  const getProgressColor = (progress: number) => {
    if (progress >= 80) return "#0F766E";
    if (progress >= 60) return "#C88A2B";
    return "#C94F3D";
  };
  
  const getProgressBgColor = (progress: number) => {
    if (progress >= 80) return "#E8F5F3";
    if (progress >= 60) return "#FEF3E7";
    return "#FFE5E5";
  };

  const formatCurrency = (amount: number) => {
    return `₱${(amount / 1000000).toFixed(2)}M`;
  };

  // Detail View
  if (view === "detail" && selectedCustomer) {
    return (
      <CustomerLedgerDetail 
        customer={selectedCustomer} 
        onClose={() => { setSelectedCustomer(null); setView("list"); }} 
      />
    );
  }

  // List View
  return (
    <div className="h-full flex flex-col bg-white">
      {/* Header & Controls */}
      <div className="px-12 py-8">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-[32px] font-semibold text-[#12332B] mb-1 tracking-tight">
              Customers
            </h1>
            <p className="text-sm text-[#667085]">
              Manage customer companies and prospects
            </p>
          </div>
          <button
            onClick={() => setIsAddCustomerOpen(true)}
            className="h-12 px-6 rounded-2xl bg-[#0F766E] border-none text-white text-sm font-semibold flex items-center gap-2 cursor-pointer hover:bg-[#0D6560] transition-colors"
          >
            <Plus size={20} />
            Add Customer
          </button>
        </div>

        {/* KPI Section */}
        <div className="grid grid-cols-4 gap-4 mb-6">
          {/* New Customers Added */}
          <div className="p-5 rounded-xl border border-[1.5px] border-[var(--neuron-ui-border)] bg-white">
            <div className="flex items-start justify-between mb-3">
              <div className="p-2 rounded-lg bg-[#E8F5F3]">
                <Building2 size={18} style={{ color: "#0F766E" }} />
              </div>
              <div className="flex items-center gap-1">
                {newCustomersTrend > 0 ? <ArrowUp size={14} className="text-[#0F766E]" /> : <ArrowDown size={14} className="text-[#C94F3D]" />}
                <span className="text-xs" style={{ color: newCustomersTrend > 0 ? "#0F766E" : "#C94F3D" }}>{Math.abs(newCustomersTrend)}%</span>
              </div>
            </div>
            <div className="space-y-2">
              <p className="text-xs text-[var(--neuron-ink-muted)]">New Customers Added</p>
              <div className="flex items-end gap-1">
                <span className="text-2xl text-[var(--neuron-ink-primary)]">{newCustomersAdded}</span>
                <span className="text-xs mb-1 text-[var(--neuron-ink-muted)]">/ {newCustomersQuota}</span>
              </div>
              <div className="w-full h-1.5 rounded-full overflow-hidden" style={{ backgroundColor: getProgressBgColor(newCustomersProgress) }}>
                <div className="h-full rounded-full transition-all" style={{ width: `${Math.min(newCustomersProgress, 100)}%`, backgroundColor: getProgressColor(newCustomersProgress) }} />
              </div>
            </div>
          </div>

          {/* Prospects Converted */}
          <div className="p-5 rounded-xl border border-[1.5px] border-[var(--neuron-ui-border)] bg-white">
            <div className="flex items-start justify-between mb-3">
              <div className="p-2 rounded-lg bg-[#E8F5F3]">
                <Target size={18} style={{ color: "#0F766E" }} />
              </div>
              <div className="flex items-center gap-1">
                {prospectsTrend > 0 ? <ArrowUp size={14} className="text-[#0F766E]" /> : <ArrowDown size={14} className="text-[#C94F3D]" />}
                <span className="text-xs" style={{ color: prospectsTrend > 0 ? "#0F766E" : "#C94F3D" }}>{Math.abs(prospectsTrend)}%</span>
              </div>
            </div>
            <div className="space-y-2">
              <p className="text-xs text-[var(--neuron-ink-muted)]">Prospects Converted</p>
              <div className="flex items-end gap-1">
                <span className="text-2xl text-[var(--neuron-ink-primary)]">{prospectsConverted}</span>
                <span className="text-xs mb-1 text-[var(--neuron-ink-muted)]">/ {prospectsQuota}</span>
              </div>
              <div className="w-full h-1.5 rounded-full overflow-hidden" style={{ backgroundColor: getProgressBgColor(prospectsProgress) }}>
                <div className="h-full rounded-full transition-all" style={{ width: `${Math.min(prospectsProgress, 100)}%`, backgroundColor: getProgressColor(prospectsProgress) }} />
              </div>
            </div>
          </div>

          {/* Active Customers */}
          <div className="p-5 rounded-xl border border-[1.5px] border-[var(--neuron-ui-border)] bg-white">
            <div className="flex items-start justify-between mb-3">
              <div className="p-2 rounded-lg bg-[#E8F5F3]">
                <Briefcase size={18} style={{ color: "#0F766E" }} />
              </div>
              <div className="flex items-center gap-1">
                {activeCustomersTrend > 0 ? <ArrowUp size={14} className="text-[#0F766E]" /> : <ArrowDown size={14} className="text-[#C94F3D]" />}
                <span className="text-xs" style={{ color: activeCustomersTrend > 0 ? "#0F766E" : "#C94F3D" }}>{Math.abs(activeCustomersTrend)}%</span>
              </div>
            </div>
            <div className="space-y-2">
              <p className="text-xs text-[var(--neuron-ink-muted)]">Active Customers</p>
              <div className="flex items-end gap-1">
                <span className="text-2xl text-[var(--neuron-ink-primary)]">{activeCustomersCount}</span>
                <span className="text-xs mb-1 text-[var(--neuron-ink-muted)]">/ {activeCustomersQuota}</span>
              </div>
              <div className="w-full h-1.5 rounded-full overflow-hidden" style={{ backgroundColor: getProgressBgColor(activeCustomersProgress) }}>
                <div className="h-full rounded-full transition-all" style={{ width: `${Math.min(activeCustomersProgress, 100)}%`, backgroundColor: getProgressColor(activeCustomersProgress) }} />
              </div>
            </div>
          </div>

          {/* Total Revenue */}
          <div className="p-5 rounded-xl border border-[1.5px] border-[var(--neuron-ui-border)] bg-white">
            <div className="flex items-start justify-between mb-3">
              <div className="p-2 rounded-lg bg-[#E8F5F3]">
                <TrendingUp size={18} style={{ color: "#0F766E" }} />
              </div>
              <div className="flex items-center gap-1">
                {revenueTrend > 0 ? <ArrowUp size={14} className="text-[#0F766E]" /> : <ArrowDown size={14} className="text-[#C94F3D]" />}
                <span className="text-xs" style={{ color: revenueTrend > 0 ? "#0F766E" : "#C94F3D" }}>{Math.abs(revenueTrend)}%</span>
              </div>
            </div>
            <div className="space-y-2">
              <p className="text-xs text-[var(--neuron-ink-muted)]">Total Revenue (MTD)</p>
              <div className="flex items-end gap-1">
                <span className="text-2xl text-[var(--neuron-ink-primary)]">{formatCurrency(totalRevenue)}</span>
                <span className="text-xs mb-1 text-[var(--neuron-ink-muted)]">/ {formatCurrency(revenueQuota)}</span>
              </div>
              <div className="w-full h-1.5 rounded-full overflow-hidden" style={{ backgroundColor: getProgressBgColor(revenueProgress) }}>
                <div className="h-full rounded-full transition-all" style={{ width: `${Math.min(revenueProgress, 100)}%`, backgroundColor: getProgressColor(revenueProgress) }} />
              </div>
            </div>
          </div>
        </div>

        {/* Filters & Search */}
        <div className="flex items-center gap-2 mb-2">
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[var(--neuron-ink-muted)]" />
            <input
              type="text"
              placeholder="Search customers..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-10 pr-4 py-2 rounded-lg focus:outline-none focus:ring-2 text-[13px] border-[1.5px] border-[var(--neuron-ui-border)] bg-white text-[var(--neuron-ink-primary)] focus:border-[#0F766E]"
            />
          </div>

          <div style={{ minWidth: "150px" }}>
            <CustomDropdown
              value={industryFilter}
              onChange={(value) => setIndustryFilter(value as Industry | "All")}
              options={[
                { value: "All", label: "All Industries" },
                { value: "Garments", label: "Garments" },
                { value: "Automobile", label: "Automobile" },
                { value: "Energy", label: "Energy" },
                { value: "Food & Beverage", label: "Food & Beverage" },
                { value: "Heavy Equipment", label: "Heavy Equipment" },
                { value: "Construction", label: "Construction" },
                { value: "Agricultural", label: "Agricultural" },
                { value: "Pharmaceutical", label: "Pharmaceutical" },
                { value: "IT", label: "IT" },
                { value: "Electronics", label: "Electronics" },
                { value: "General Merchandise", label: "General Merchandise" }
              ]}
            />
          </div>

          <div style={{ minWidth: "140px" }}>
            <CustomDropdown
              value={statusFilter}
              onChange={(value) => setStatusFilter(value as CustomerStatus | "All")}
              options={[
                { value: "All", label: "All Statuses" },
                { value: "Prospect", label: "Prospect" },
                { value: "Active", label: "Active" },
                { value: "Inactive", label: "Inactive" }
              ]}
            />
          </div>

          <div style={{ minWidth: "140px" }}>
            <CustomDropdown
              value={ownerFilter}
              onChange={(value) => setOwnerFilter(value)}
              options={[
                { value: "All", label: "All Owners" },
                ...users.map(user => ({ value: user.id, label: user.name }))
              ]}
            />
          </div>
        </div>

        {/* Table */}
        <div className="border-[1.5px] border-[var(--neuron-ui-border)] rounded-2xl overflow-hidden bg-white">
          {/* Table Header */}
          <div className="grid grid-cols-[40px_minmax(200px,1fr)_minmax(120px,140px)_100px_80px_120px_40px] gap-3 px-6 py-3 border-b border-[var(--neuron-ui-divider)] bg-[var(--neuron-bg-page)] sticky top-0 z-10">
            <div></div>
            <div className="text-[11px] font-medium uppercase tracking-wide text-[var(--neuron-ink-muted)]">Company</div>
            <div className="text-[11px] font-medium uppercase tracking-wide text-[var(--neuron-ink-muted)]">Industry</div>
            <div className="text-[11px] font-medium uppercase tracking-wide text-[var(--neuron-ink-muted)]">Status</div>
            <div className="text-[11px] font-medium uppercase tracking-wide text-[var(--neuron-ink-muted)]">Contacts</div>
            <div className="text-[11px] font-medium uppercase tracking-wide text-[var(--neuron-ink-muted)]">Last Activity</div>
            <div></div>
          </div>

          {/* Table Body */}
          <div className="divide-y divide-[var(--neuron-ui-divider)]">
            {isLoading ? (
              <div className="py-12 text-center text-[var(--neuron-ink-muted)]">Loading customers...</div>
            ) : filteredCustomers.length === 0 ? (
              <div className="py-12 text-center text-[var(--neuron-ink-muted)]">No customers found</div>
            ) : (
              filteredCustomers.map((customer) => {
                const initials = getCompanyInitials(customer.name || customer.company_name || '');
                const logoColor = getCompanyLogoColor(customer.name || customer.company_name || '');
                const contactCount = getContactCount(customer.id);
                const lastActivityDate = getLastActivityDate(customer.id);
                
                return (
                  <div 
                    key={customer.id}
                    className="grid grid-cols-[40px_minmax(200px,1fr)_minmax(120px,140px)_100px_80px_120px_40px] gap-3 px-6 py-4 items-center hover:bg-gray-50 transition-colors cursor-pointer group"
                    onClick={() => {
                      setSelectedCustomer(customer);
                      setView("detail");
                    }}
                  >
                    {/* Logo */}
                    <div 
                      className="w-8 h-8 rounded-lg flex items-center justify-center text-[10px] font-bold"
                      style={{
                        backgroundColor: `${logoColor}15`,
                        color: logoColor,
                        border: `1px solid ${logoColor}30`
                      }}
                    >
                      {initials}
                    </div>

                    {/* Company Name & Owner */}
                    <div className="min-w-0">
                      <div className="text-[13px] font-medium text-[var(--neuron-ink-primary)] truncate">
                        {customer.name || customer.company_name}
                      </div>
                      <div className="text-[11px] text-[var(--neuron-ink-muted)] truncate">
                        {customer.type || "Prospect"}
                      </div>
                    </div>

                    {/* Industry */}
                    <div className="text-[13px] text-[var(--neuron-ink-secondary)] truncate">
                      {customer.industry || "—"}
                    </div>

                    {/* Status */}
                    <div>
                      <span 
                        className="inline-flex items-center px-2 py-0.5 rounded text-[11px] font-medium text-white"
                        style={{ backgroundColor: getStatusColor(customer.status) }}
                      >
                        {customer.status}
                      </span>
                    </div>

                    {/* Contacts */}
                    <div className="flex items-center gap-1.5 text-[13px] text-[var(--neuron-ink-secondary)]">
                      <UsersIcon size={14} className="text-[var(--neuron-ink-muted)]" />
                      {contactCount}
                    </div>

                    {/* Last Activity */}
                    <div className="text-[12px] text-[var(--neuron-ink-muted)] truncate">
                      {formatDate(lastActivityDate) === "—" ? "No activity" : formatDate(lastActivityDate)}
                    </div>

                    {/* Actions */}
                    <div className="relative flex justify-end">
                      <button 
                        className="p-1 rounded-md text-gray-400 hover:text-gray-600 hover:bg-gray-100 opacity-0 group-hover:opacity-100 transition-opacity"
                        onClick={(e) => {
                          e.stopPropagation();
                          setOpenDropdownId(openDropdownId === customer.id ? null : customer.id);
                        }}
                      >
                        <MoreHorizontal size={16} />
                      </button>

                      {openDropdownId === customer.id && (
                        <div 
                          ref={dropdownRef}
                          className="absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20"
                          onClick={(e) => e.stopPropagation()}
                        >
                          <button
                            className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                            onClick={() => handleDeleteCustomer(customer.id, customer.name || customer.company_name || "")}
                          >
                            <Trash2 size={14} />
                            Delete Customer
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      </div>

      {/* Add Customer Panel */}
      <AddCustomerPanel 
        isOpen={isAddCustomerOpen}
        onClose={() => setIsAddCustomerOpen(false)}
        onSave={handleSaveCustomer}
      />
    </div>
  );
}
