import { useState, useEffect } from "react";
import { projectId, publicAnonKey } from "../../../utils/supabase/info";
import { UnifiedExpensesTab } from "../../accounting/UnifiedExpensesTab";
import type { Expense as OperationsExpense } from "../../../types/operations";

interface ExpensesTabProps {
  bookingId: string;
  bookingType?: "forwarding" | "brokerage" | "trucking" | "marine-insurance" | "others";
  currentUserId?: string;
  currentUserName?: string;
  currentUserDepartment?: string;
  currentUser?: { name: string; email: string; department: string } | null;
  readOnly?: boolean;
}

const API_URL = `https://${projectId}.supabase.co/functions/v1/make-server-c142e950`;

export function ExpensesTab({ 
  bookingId, 
  bookingType, 
  currentUser, 
  readOnly = false 
}: ExpensesTabProps) {
  // Data State
  const [expenses, setExpenses] = useState<OperationsExpense[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    fetchExpenses();
  }, [bookingId]);

  const fetchExpenses = async () => {
    try {
      setIsLoading(true);
      
      const response = await fetch(`${API_URL}/evouchers`, {
        headers: {
          'Authorization': `Bearer ${publicAnonKey}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const result = await response.json();
        
        if (result.success && result.data) {
          const allEVouchers = result.data || [];
          
          // Filter for this specific booking
          const relevantEVouchers = allEVouchers.filter((ev: any) => {
            // 1. Must match the booking ID (either in project_number or booking_id fields)
            const matchesBooking = 
                ev.project_number === bookingId || 
                ev.booking_id === bookingId;
            
            if (!matchesBooking) return false;

            // 2. Must be an Expense or Budget Request
            const type = (ev.transaction_type || "").toLowerCase();
            return type === "expense" || type === "budget_request";
          });

          // Map to OperationsExpense type
          const mappedExpenses: OperationsExpense[] = relevantEVouchers.map((ev: any) => {
            let status = "pending";
            const rawStatus = (ev.status || "").toLowerCase();
            if (rawStatus === "draft") status = "draft";
            else if (rawStatus === "approved") status = "approved";
            else if (rawStatus === "posted" || rawStatus === "paid") status = "posted";
            else if (rawStatus === "rejected" || rawStatus === "cancelled") status = "rejected";

            return {
              expenseId: ev.id,
              id: ev.id,
              bookingId: bookingId,
              bookingType: bookingType || "Other", // Default to Other if unknown
              expenseName: ev.voucher_number || ev.id,
              expenseCategory: ev.expense_category || "Uncategorized",
              amount: ev.total_amount || ev.amount || 0,
              currency: ev.currency || "PHP",
              expenseDate: ev.request_date || ev.created_at,
              vendorName: ev.vendor_name || "â€”",
              description: ev.purpose || ev.description,
              notes: ev.description,
              createdBy: ev.requestor_name,
              createdAt: ev.created_at,
              status: status,
              vendor: ev.vendor_name,
              category: ev.expense_category,
              subCategory: ev.sub_category,
              lineItems: ev.line_items || [],
              isBillable: ev.is_billable
            } as OperationsExpense;
          });

          // Sort by Date (Newest first)
          mappedExpenses.sort((a, b) => {
             const timeA = new Date(a.expenseDate || a.createdAt).getTime();
             const timeB = new Date(b.expenseDate || b.createdAt).getTime();
             return timeB - timeA;
          });

          setExpenses(mappedExpenses);
        }
      }
    } catch (error) {
      console.error("Error fetching expenses:", error);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="flex flex-col bg-white p-12 min-h-[600px]">
      <UnifiedExpensesTab 
        expenses={expenses}
        isLoading={isLoading}
        showHeader={true}
        linkedBookings={[]} // No linked bookings in single view
        context="booking"   // "booking" context hides the Booking Column
        onRefresh={fetchExpenses}
        projectNumber={bookingId} // Pass bookingId as projectNumber for creating new expenses
        bookingType={bookingType}
      />
    </div>
  );
}