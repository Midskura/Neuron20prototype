import { useState } from "react";
import { Project } from "../../types/pricing";
import { NeuronStatusPill } from "../NeuronStatusPill";
import { Search, Briefcase, CheckCircle, Package, Calendar, CircleDot, Ship, Truck, Shield, User, TrendingUp, TrendingDown, DollarSign, AlertCircle } from "lucide-react";
import { CustomDropdown } from "../bd/CustomDropdown";
import { useProjectsFinancialsMap } from "../../hooks/useProjectsFinancialsMap";
import { SkeletonTable, SkeletonControlBar } from "../shared/NeuronSkeleton";
import { NeuronRefreshButton } from "../shared/NeuronRefreshButton";

interface ProjectsListProps {
  projects: Project[];
  onSelectProject: (project: Project) => void;
  isLoading?: boolean;
  currentUser?: { 
    id: string;
    name: string; 
    email: string; 
    department: string;
  } | null;
  department: "BD" | "Operations" | "Accounting";
  onRefresh?: () => Promise<void>;
}

export function ProjectsList({ 
  projects, 
  onSelectProject, 
  isLoading,
  currentUser,
  department,
  onRefresh,
}: ProjectsListProps) {
  const [searchQuery, setSearchQuery] = useState("");
  const [activeTab, setActiveTab] = useState<"all" | "my" | "active" | "completed">("all");
  
  // Filters
  const [timePeriodFilter, setTimePeriodFilter] = useState<string>("all");
  const [statusFilter, setStatusFilter] = useState<string>("all");
  const [bookingStatusFilter, setBookingStatusFilter] = useState<string>("all");
  const [serviceFilter, setServiceFilter] = useState<string>("all");
  const [ownerFilter, setOwnerFilter] = useState<string>("all");
  const [marginFilter, setMarginFilter] = useState<string>("all");
  const [profitFilter, setProfitFilter] = useState<string>("all");

  // Fetch actual financials (now using strict accounting logic)
  const { financialsMap, isLoading: isLoadingFinancials } = useProjectsFinancialsMap(projects);

  // Grid template constant
  const GRID_COLS = "240px 200px 120px 120px 120px 100px 100px";

  const formatCurrency = (amount: number, currency: string = "PHP") => {
    return new Intl.NumberFormat("en-PH", {
      style: "currency",
      currency: currency,
    }).format(amount);
  };

  const uniqueOwners = Array.from(new Set(projects.map(p => p.bd_owner_user_name).filter(Boolean)));
  const uniqueServices = Array.from(new Set(projects.flatMap(p => p.services || [])));

  // Filter projects based on active tab
  const getFilteredByTab = () => {
    let filtered = projects;

    // "My Projects" tab logic (Only for BD/Ops)
    if (activeTab === "my") {
      filtered = projects.filter(p => 
        p.bd_owner_user_name === currentUser?.name ||
        p.bd_owner_email === currentUser?.email
      );
    }

    if (activeTab === "active") {
      return filtered.filter(p => p.status === "Active");
    }
    if (activeTab === "completed") {
      return filtered.filter(p => p.status === "Completed");
    }
    return filtered;
  };

  // Apply all filters
  const filteredProjects = getFilteredByTab().filter((project) => {
    // Search filter
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      const matchesSearch = 
        project.project_number.toLowerCase().includes(query) ||
        project.customer_name.toLowerCase().includes(query) ||
        project.quotation_number?.toLowerCase().includes(query) ||
        project.quotation_name?.toLowerCase().includes(query);
      if (!matchesSearch) return false;
    }
    
    // Time period filter
    if (timePeriodFilter !== "all") {
      const projectDate = new Date(project.created_at);
      const now = new Date();
      const daysDiff = Math.floor((now.getTime() - projectDate.getTime()) / (1000 * 60 * 60 * 24));
      
      if (timePeriodFilter === "7days" && daysDiff > 7) return false;
      if (timePeriodFilter === "30days" && daysDiff > 30) return false;
      if (timePeriodFilter === "90days" && daysDiff > 90) return false;
    }
    
    // Financial Data for filtering
    const stats = financialsMap[project.project_number] || { income: 0, costs: 0, grossProfit: 0, margin: 0 };

    if (department === "Accounting") {
      // Margin Filter
      if (marginFilter !== "all") {
        if (marginFilter === "high" && stats.margin < 20) return false;
        if (marginFilter === "low" && (stats.margin >= 20 || stats.margin < 0)) return false;
        if (marginFilter === "loss" && stats.margin >= 0) return false;
      }

      // Profit Filter
      if (profitFilter !== "all") {
         if (profitFilter === "profitable" && stats.grossProfit <= 0) return false;
         if (profitFilter === "loss" && stats.grossProfit >= 0) return false;
      }
    } else {
      // BD/Ops Filters
      
      // Status filter
      if (statusFilter !== "all" && project.status !== statusFilter) return false;
      
      // Booking status filter
      if (bookingStatusFilter !== "all") {
        const projectBookingStatus = project.booking_status || "No Bookings Yet";
        if (projectBookingStatus !== bookingStatusFilter) return false;
      }
      
      // Service filter
      if (serviceFilter !== "all") {
        if (!project.services?.includes(serviceFilter)) return false;
      }
      
      // Owner filter
      if (ownerFilter !== "all" && project.bd_owner_user_name !== ownerFilter) return false;
    }
    
    return true;
  });

  // Calculate counts
  const allCount = projects.length;
  const myCount = projects.filter(p => 
    p.bd_owner_user_name === currentUser?.name ||
    p.bd_owner_email === currentUser?.email
  ).length;
  const activeCount = projects.filter(p => p.status === "Active").length;
  const completedCount = projects.filter(p => p.status === "Completed").length;

  return (
    <div style={{ height: "100vh", display: "flex", flexDirection: "column", background: "white" }}>
      <div style={{ padding: "32px 48px" }}>
        {/* Header */}
        <div style={{ display: "flex", alignItems: "start", justifyContent: "space-between", marginBottom: "32px" }}>
          <div>
            <h1 style={{ 
              fontSize: "32px", 
              fontWeight: 600, 
              color: "#12332B", 
              marginBottom: "4px",
              letterSpacing: "-1.2px"
            }}>
              Projects
            </h1>
            <p style={{ 
              fontSize: "14px", 
              color: "#667085"
            }}>
              {department === "Accounting" 
                ? "Monitor revenue, costs, and margins across all active shipments"
                : department === "BD" 
                  ? "Manage approved quotations and project execution"
                  : "View assigned projects and bookings"}
            </p>
          </div>
          {onRefresh && (
            <NeuronRefreshButton 
              onRefresh={onRefresh}
              label="Refresh projects"
            />
          )}
        </div>

        {/* Search Bar */}
        <div style={{ position: "relative", marginBottom: "12px" }}>
          <Search
            size={18}
            style={{
              position: "absolute",
              left: "12px",
              top: "50%",
              transform: "translateY(-50%)",
              color: "#667085",
            }}
          />
          <input
            type="text"
            placeholder={department === "Accounting" ? "Search projects by number, name, or customer..." : "Search projects by number, customer, or quotation..."}
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            style={{
              width: "100%",
              padding: "10px 12px 10px 40px",
              border: "1px solid #E5E7EB",
              borderRadius: "8px",
              fontSize: "14px",
              outline: "none",
              color: "#12332B",
              backgroundColor: "#FFFFFF",
            }}
          />
        </div>

        {/* Filters Row */}
        <div style={{ 
          display: "flex",
          gap: "4px",
          marginBottom: "16px",
          alignItems: "center",
          flexWrap: "wrap"
        }}>
          {/* Common: Time Period Filter */}
          <div style={{ minWidth: "120px" }}>
            <CustomDropdown
              value={timePeriodFilter}
              onChange={setTimePeriodFilter}
              options={[
                { value: "all", label: "All Time", icon: <Calendar size={16} /> },
                { value: "7days", label: "Last 7 days", icon: <Calendar size={16} /> },
                { value: "30days", label: "Last 30 days", icon: <Calendar size={16} /> },
                { value: "90days", label: "Last 90 days", icon: <Calendar size={16} /> }
              ]}
              placeholder="Select time period"
            />
          </div>

          {department === "Accounting" ? (
            <>
              {/* Margin Filter */}
              <div style={{ minWidth: "150px" }}>
                <CustomDropdown
                  value={marginFilter}
                  onChange={setMarginFilter}
                  options={[
                    { value: "all", label: "All Margins", icon: <TrendingUp size={16} /> },
                    { value: "high", label: "High Margin (>20%)", icon: <TrendingUp size={16} style={{ color: "#10B981" }} /> },
                    { value: "low", label: "Low Margin (<20%)", icon: <TrendingDown size={16} style={{ color: "#F59E0B" }} /> },
                    { value: "loss", label: "Loss Making (<0%)", icon: <AlertCircle size={16} style={{ color: "#EF4444" }} /> }
                  ]}
                  placeholder="Filter by margin"
                />
              </div>

              {/* Profit Status Filter */}
              <div style={{ minWidth: "140px" }}>
                <CustomDropdown
                  value={profitFilter}
                  onChange={setProfitFilter}
                  options={[
                    { value: "all", label: "All Status", icon: <DollarSign size={16} /> },
                    { value: "profitable", label: "Profitable", icon: <CheckCircle size={16} style={{ color: "#10B981" }} /> },
                    { value: "loss", label: "Loss", icon: <AlertCircle size={16} style={{ color: "#EF4444" }} /> }
                  ]}
                  placeholder="Profit status"
                />
              </div>
            </>
          ) : (
            <>
              {/* BD/Ops Filters */}
              
              {/* Status Filter */}
              <div style={{ minWidth: "120px" }}>
                <CustomDropdown
                  value={statusFilter}
                  onChange={setStatusFilter}
                  options={[
                    { value: "all", label: "All Statuses", icon: <CircleDot size={16} /> },
                    { value: "Active", label: "Active", icon: <CircleDot size={16} style={{ color: "#F59E0B" }} /> },
                    { value: "Completed", label: "Completed", icon: <CheckCircle size={16} style={{ color: "#10B981" }} /> },
                    { value: "On Hold", label: "On Hold", icon: <CircleDot size={16} style={{ color: "#6B7280" }} /> },
                    { value: "Cancelled", label: "Cancelled", icon: <CircleDot size={16} style={{ color: "#EF4444" }} /> }
                  ]}
                  placeholder="Select status"
                />
              </div>

              {/* Booking Status Filter */}
              <div style={{ minWidth: "150px" }}>
                <CustomDropdown
                  value={bookingStatusFilter}
                  onChange={setBookingStatusFilter}
                  options={[
                    { value: "all", label: "All Booking Statuses", icon: <Package size={16} /> },
                    { value: "No Bookings Yet", label: "No Bookings Yet", icon: <Package size={16} style={{ color: "#6B7280" }} /> },
                    { value: "Partially Booked", label: "Partially Booked", icon: <Package size={16} style={{ color: "#F59E0B" }} /> },
                    { value: "Fully Booked", label: "Fully Booked", icon: <CheckCircle size={16} style={{ color: "#10B981" }} /> }
                  ]}
                  placeholder="Select booking status"
                />
              </div>

              {/* Service Filter */}
              <div style={{ minWidth: "120px" }}>
                <CustomDropdown
                  value={serviceFilter}
                  onChange={setServiceFilter}
                  options={[
                    { value: "all", label: "All Services", icon: <Briefcase size={16} /> },
                    ...uniqueServices.map(service => {
                      const getServiceIcon = () => {
                        if (service === "Brokerage") return <Briefcase size={16} style={{ color: "#0F766E" }} />;
                        if (service === "Forwarding") return <Ship size={16} style={{ color: "#0F766E" }} />;
                        if (service === "Trucking") return <Truck size={16} style={{ color: "#0F766E" }} />;
                        if (service === "Marine Insurance") return <Shield size={16} style={{ color: "#0F766E" }} />;
                        return <Package size={16} style={{ color: "#0F766E" }} />;
                      };
                      return { value: service, label: service, icon: getServiceIcon() };
                    })
                  ]}
                  placeholder="Select service"
                />
              </div>

              {/* Owner Filter */}
              <div style={{ minWidth: "120px" }}>
                <CustomDropdown
                  value={ownerFilter}
                  onChange={setOwnerFilter}
                  options={[
                    { value: "all", label: "All Owners", icon: <User size={16} /> },
                    ...uniqueOwners.map(owner => ({ 
                      value: owner, 
                      label: owner, 
                      icon: <User size={16} style={{ color: "#0F766E" }} /> 
                    }))
                  ]}
                  placeholder="Select owner"
                />
              </div>
            </>
          )}
        </div>

        {/* Tabs */}
        <div style={{ 
          display: "flex", 
          gap: "8px", 
          borderBottom: "1px solid #E5E7EB",
          marginBottom: "24px"
        }}>
          <button
            onClick={() => setActiveTab("all")}
            style={{
              display: "flex",
              alignItems: "center",
              gap: "8px",
              padding: "12px 20px",
              background: "transparent",
              border: "none",
              borderBottom: activeTab === "all" ? "2px solid #0F766E" : "2px solid transparent",
              color: activeTab === "all" ? "#0F766E" : "#667085",
              fontSize: "14px",
              fontWeight: 600,
              cursor: "pointer",
              transition: "all 0.2s ease",
              marginBottom: "-1px"
            }}
          >
            <Briefcase size={18} />
            All Projects
            <span
              style={{
                padding: "2px 8px",
                borderRadius: "12px",
                fontSize: "11px",
                fontWeight: 700,
                background: activeTab === "all" ? "#0F766E" : "#0F766E15",
                color: activeTab === "all" ? "#FFFFFF" : "#0F766E",
                minWidth: "20px",
                textAlign: "center"
              }}
            >
              {allCount}
            </span>
          </button>

          {department !== "Accounting" && (
            <button
              onClick={() => setActiveTab("my")}
              style={{
                display: "flex",
                alignItems: "center",
                gap: "8px",
                padding: "12px 20px",
                background: "transparent",
                border: "none",
                borderBottom: activeTab === "my" ? "2px solid #0F766E" : "2px solid transparent",
                color: activeTab === "my" ? "#0F766E" : "#667085",
                fontSize: "14px",
                fontWeight: 600,
                cursor: "pointer",
                transition: "all 0.2s ease",
                marginBottom: "-1px"
              }}
            >
              <User size={18} />
              My Projects
              <span
                style={{
                  padding: "2px 8px",
                  borderRadius: "12px",
                  fontSize: "11px",
                  fontWeight: 700,
                  background: activeTab === "my" ? "#0F766E" : "#0F766E15",
                  color: activeTab === "my" ? "#FFFFFF" : "#0F766E",
                  minWidth: "20px",
                  textAlign: "center"
                }}
              >
                {myCount}
              </span>
            </button>
          )}
          
          <button
            onClick={() => setActiveTab("active")}
            style={{
              display: "flex",
              alignItems: "center",
              gap: "8px",
              padding: "12px 20px",
              background: "transparent",
              border: "none",
              borderBottom: activeTab === "active" ? "2px solid #F59E0B" : "2px solid transparent",
              color: activeTab === "active" ? "#F59E0B" : "#667085",
              fontSize: "14px",
              fontWeight: 600,
              cursor: "pointer",
              transition: "all 0.2s ease",
              marginBottom: "-1px"
            }}
          >
            <Package size={18} />
            Active
            <span
              style={{
                padding: "2px 8px",
                borderRadius: "12px",
                fontSize: "11px",
                fontWeight: 700,
                background: activeTab === "active" ? "#F59E0B" : "#F59E0B15",
                color: activeTab === "active" ? "#FFFFFF" : "#F59E0B",
                minWidth: "20px",
                textAlign: "center"
              }}
            >
              {activeCount}
            </span>
          </button>
          
          <button
            onClick={() => setActiveTab("completed")}
            style={{
              display: "flex",
              alignItems: "center",
              gap: "8px",
              padding: "12px 20px",
              background: "transparent",
              border: "none",
              borderBottom: activeTab === "completed" ? "2px solid #10B981" : "2px solid transparent",
              color: activeTab === "completed" ? "#10B981" : "#667085",
              fontSize: "14px",
              fontWeight: 600,
              cursor: "pointer",
              transition: "all 0.2s ease",
              marginBottom: "-1px"
            }}
          >
            <CheckCircle size={18} />
            Completed
            <span
              style={{
                padding: "2px 8px",
                borderRadius: "12px",
                fontSize: "11px",
                fontWeight: 700,
                background: activeTab === "completed" ? "#10B981" : "#10B98115",
                color: activeTab === "completed" ? "#FFFFFF" : "#10B981",
                minWidth: "20px",
                textAlign: "center"
              }}
            >
              {completedCount}
            </span>
          </button>
        </div>

        {/* Table */}
        {isLoading || isLoadingFinancials ? (
          <div className="mt-2">
            <SkeletonTable rows={10} cols={7} />
          </div>
        ) : filteredProjects.length === 0 ? (
          <div style={{ 
            padding: "64px", 
            textAlign: "center", 
            maxWidth: "600px", 
            margin: "0 auto"
          }}>
            <div className="text-center py-12">
              <Package size={48} style={{ color: "#D1D5DB", margin: "0 auto 16px" }} />
              <p className="text-[14px]" style={{ color: "#667085" }}>
                {projects.length === 0 ? "No Projects Yet" : "No projects match your filters"}
              </p>
            </div>
          </div>
        ) : (
          <div style={{ 
            background: "#FFFFFF",
            border: "1px solid #E5E7EB",
            borderRadius: "12px",
            overflow: "hidden"
          }}>
            {/* Table Header */}
            <div 
              className="grid gap-4 px-6 py-4"
              style={{ 
                gridTemplateColumns: GRID_COLS,
                borderBottom: "1px solid #E5E7EB",
                background: "#F9FAFB"
              }}
            >
              <div style={{ fontSize: "11px", fontWeight: 600, color: "#6B7280", textTransform: "uppercase", letterSpacing: "0.5px" }}>
                PROJECT
              </div>
              <div style={{ fontSize: "11px", fontWeight: 600, color: "#6B7280", textTransform: "uppercase", letterSpacing: "0.5px" }}>
                CUSTOMER
              </div>
              <div style={{ fontSize: "11px", fontWeight: 600, color: "#6B7280", textTransform: "uppercase", letterSpacing: "0.5px", textAlign: "right" }}>
                INCOME
              </div>
              <div style={{ fontSize: "11px", fontWeight: 600, color: "#6B7280", textTransform: "uppercase", letterSpacing: "0.5px", textAlign: "right" }}>
                COSTS
              </div>
              <div style={{ fontSize: "11px", fontWeight: 600, color: "#6B7280", textTransform: "uppercase", letterSpacing: "0.5px", textAlign: "right" }}>
                GROSS PROFIT
              </div>
              <div style={{ fontSize: "11px", fontWeight: 600, color: "#6B7280", textTransform: "uppercase", letterSpacing: "0.5px", textAlign: "right" }}>
                MARGIN
              </div>
              <div style={{ fontSize: "11px", fontWeight: 600, color: "#6B7280", textTransform: "uppercase", letterSpacing: "0.5px", textAlign: "center" }}>
                STATUS
              </div>
            </div>

            {/* Table Body */}
            {filteredProjects.map((project, index) => {
              const stats = financialsMap[project.project_number] || { income: 0, costs: 0, grossProfit: 0, margin: 0 };
              
              return (
                <div
                  key={project.id}
                  className="grid gap-4 px-6 py-4 transition-colors cursor-pointer"
                  style={{ 
                    gridTemplateColumns: GRID_COLS,
                    borderBottom: index < filteredProjects.length - 1 ? "1px solid #E5E7EB" : "none",
                  }}
                  onClick={() => onSelectProject(project)}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = "#F9FAFB";
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = "transparent";
                  }}
                >
                  <div style={{ display: "flex", alignItems: "center", gap: "12px", overflow: "hidden" }}>
                    <div style={{
                        width: "32px",
                        height: "32px",
                        borderRadius: "6px",
                        backgroundColor: "#F0FDF9",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        flexShrink: 0,
                        border: "1px solid #CCFBF1"
                    }}>
                        <Briefcase size={16} color="#0F766E" />
                    </div>
                    
                    <div style={{ overflow: "hidden", width: "100%" }}>
                      <div style={{ 
                        fontSize: "13px", 
                        fontWeight: 600, 
                        color: "#12332B",
                        marginBottom: "2px",
                        whiteSpace: "nowrap",
                        overflow: "hidden",
                        textOverflow: "ellipsis"
                      }}>
                        {project.quotation_name || project.project_number}
                      </div>
                      <div style={{ 
                        fontSize: "12px", 
                        color: "#6B7280",
                        whiteSpace: "nowrap",
                        overflow: "hidden",
                        textOverflow: "ellipsis"
                      }}>
                        {project.project_number}
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ display: "flex", alignItems: "center", overflow: "hidden" }}>
                    <div style={{ 
                      fontSize: "13px", 
                      color: "#12332B",
                      whiteSpace: "nowrap",
                      overflow: "hidden",
                      textOverflow: "ellipsis"
                    }}>
                      {project.customer_name}
                    </div>
                  </div>

                  <div style={{ display: "flex", alignItems: "center", justifyContent: "flex-end" }}>
                    <div style={{ fontSize: "13px", fontWeight: 500, color: "#059669" }}>
                      {formatCurrency(stats.income)}
                    </div>
                  </div>

                  <div style={{ display: "flex", alignItems: "center", justifyContent: "flex-end" }}>
                    <div style={{ fontSize: "13px", fontWeight: 500, color: "#B91C1C" }}>
                      {formatCurrency(stats.costs)}
                    </div>
                  </div>

                  <div style={{ display: "flex", alignItems: "center", justifyContent: "flex-end" }}>
                    <div style={{ fontSize: "13px", fontWeight: 600, color: stats.grossProfit >= 0 ? "#12332B" : "#B91C1C" }}>
                      {formatCurrency(stats.grossProfit)}
                    </div>
                  </div>

                  <div style={{ display: "flex", alignItems: "center", justifyContent: "flex-end" }}>
                    <div style={{
                      display: "inline-flex",
                      alignItems: "center",
                      padding: "2px 10px",
                      borderRadius: "12px",
                      fontSize: "11px",
                      fontWeight: 600,
                      backgroundColor: stats.margin >= 20 ? "#ECFDF5" : stats.margin >= 0 ? "#FFF7ED" : "#FEF2F2",
                      color: stats.margin >= 20 ? "#059669" : stats.margin >= 0 ? "#C2410C" : "#B91C1C"
                    }}>
                      {stats.margin.toFixed(1)}%
                    </div>
                  </div>

                  <div style={{ display: "flex", alignItems: "center", justifyContent: "center" }}>
                    <NeuronStatusPill status={project.status} size="sm" />
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}